##
# Jenga SaaS — Local Development Environment
#
# Starts WordPress (with MySQL) and the Next.js frontend.
#
# Usage:
#   docker compose up -d
#   Open WordPress admin:  http://localhost:8080/wp-admin
#   Open Frontend:         http://localhost:3000
#
# First-time setup:
#   1. Complete WordPress installation at http://localhost:8080
#   2. Activate the "Jenga SaaS Core" plugin
#   3. Create Plan posts with test Stripe Price IDs
#   4. Copy .env.example to .env in the frontend directory
##

services:
  # ── MySQL Database ─────────────────────────────────────────
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── WordPress Backend ──────────────────────────────────────
  wordpress:
    image: wordpress:6.4-php8.2-apache
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
      # Jenga SaaS configuration
      JENGA_JWT_SECRET: local-dev-jwt-secret-change-in-production
      JENGA_JWT_EXPIRATION: "3600"
      JENGA_JWT_REFRESH_EXPIRATION: "604800"
      JENGA_STRIPE_SECRET_KEY: "${STRIPE_SECRET_KEY:-sk_test_xxx}"
      JENGA_STRIPE_PUBLISHABLE_KEY: "${STRIPE_PUBLISHABLE_KEY:-pk_test_xxx}"
      JENGA_STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET:-whsec_xxx}"
      JENGA_FRONTEND_URL: "http://localhost:3000"
      JENGA_REVALIDATION_SECRET: local-dev-revalidation-secret
    volumes:
      - wordpress_data:/var/www/html
      - ./wordpress/plugins/jenga-saas-core:/var/www/html/wp-content/plugins/jenga-saas-core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-login.php"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ── Composer (install plugin dependencies) ─────────────────
  composer:
    image: composer:2
    volumes:
      - ./wordpress/plugins/jenga-saas-core:/app
    command: install --no-dev --optimize-autoloader
    profiles:
      - setup

  # ── Next.js Frontend ───────────────────────────────────────
  frontend:
    image: node:20-alpine
    working_dir: /app
    restart: unless-stopped
    depends_on:
      - wordpress
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_WP_API_URL: "http://wordpress/wp-json"
      NEXT_PUBLIC_WP_HOSTNAME: "localhost"
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: "${STRIPE_PUBLISHABLE_KEY:-pk_test_xxx}"
      STRIPE_SECRET_KEY: "${STRIPE_SECRET_KEY:-sk_test_xxx}"
      STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET:-whsec_xxx}"
      REVALIDATION_SECRET: local-dev-revalidation-secret
      NEXT_PUBLIC_APP_URL: "http://localhost:3000"
      NEXT_PUBLIC_APP_NAME: "Jenga"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev"

volumes:
  db_data:
  wordpress_data:
  frontend_node_modules:
